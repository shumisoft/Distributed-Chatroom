<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Chat Room</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                background: #f0f0f0;
            }

            #chat-container {
                width: 400px;
                background: white;
                border-radius: 8px;
                padding: 16px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                display: flex;
                flex-direction: column;
            }

            #message-area {
                flex: 1;
                overflow-y: auto;
                border: 1px solid #ddd;
                padding: 8px;
                border-radius: 4px;
                margin-bottom: 12px;
                height: 300px;
            }

            .message {
                padding: 6px 8px;
                margin-bottom: 6px;
                border-radius: 4px;
                background: #ececec;
            }

            .message.self {
                background: #d1e7ff;
                text-align: right;
            }

            #input-area {
                display: flex;
                gap: 8px;
            }

            input[type="text"] {
                flex: 1;
                padding: 8px;
            }

            button {
                padding: 8px 12px;
                cursor: pointer;
            }
        </style>
    </head>

    <body>
        <div id="chat-container">
            <div id="username-form">
                <input id="username" type="text" placeholder="Enter username" />
                <button onclick="connect()">Join</button>
            </div>

            <div id="chat" style="display: none">
                <div id="message-area"></div>

                <div id="input-area">
                    <input
                        id="message-input"
                        type="text"
                        placeholder="Type message..."
                        onkeydown="if(event.key==='Enter'){sendMessage();}"
                    />
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

        <script>
            let stompClient = null;
            let currentUser = null;

            function connect() {
                const user = document.getElementById("username").value.trim();
                if (!user) return;

                currentUser = user;

                const socket = new SockJS("/ws-chat");
                stompClient = Stomp.over(socket);

                stompClient.connect({}, () => {
                    stompClient.subscribe("/topic/public", (msg) => {
                        const data = JSON.parse(msg.body);
                        appendMessage(data);
                    });

                    stompClient.send(
                        "/app/addUser",
                        {},
                        JSON.stringify({
                            sender: currentUser,
                            type: "JOIN",
                        })
                    );

                    document.getElementById("username-form").style.display =
                        "none";
                    document.getElementById("chat").style.display = "block";
                });
            }

            function sendMessage() {
                const input = document.getElementById("message-input");
                const text = input.value.trim();
                if (!text) return;

                stompClient.send(
                    "/app/sendMessage",
                    {},
                    JSON.stringify({
                        sender: currentUser,
                        content: text,
                        type: "CHAT",
                    })
                );

                input.value = "";
            }

            function appendMessage(msg) {
                const area = document.getElementById("message-area");

                const div = document.createElement("div");
                div.classList.add("message");
                if (msg.sender === currentUser) div.classList.add("self");

                if (msg.type === "JOIN") {
                    div.innerText = msg.sender + " joined";
                } else if (msg.type === "LEAVE") {
                    div.innerText = msg.sender + " left";
                } else {
                    div.innerText = msg.sender + ": " + msg.content;
                }

                area.appendChild(div);
                area.scrollTop = area.scrollHeight;
            }
        </script>
    </body>
</html>
